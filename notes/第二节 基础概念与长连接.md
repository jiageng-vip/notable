---
tags: [Swoole]
title: 第二节 基础概念与长连接
created: '2022-05-03T09:14:14.555Z'
modified: '2022-05-03T09:28:08.327Z'
---

# 第二节 基础概念与长连接

##### 同步与异步
```
同步：对于程序执行的流程来说，一般是从上而下的方式执行，除非遇到流程控制语句会有些变化，但是原则上都会遵循这个规则：对于PHP来说在单线程模式下那么一个进程在执行PHP代码的时候就会从第一行执行到最后一行
异步：像微信 在网站上登入的时候就会发一条信息在自己的微信账号上提醒你登入了 ， 再比如一份订单生成了之后对于用户来说并不会立即收到货，而这个发货的过程我们就可以做成异步的任务由 库存模块处理 等等操作
```
##### 阻塞与非阻塞
```
阻塞：意思就是在哪里等待，要等别人执行完成才能往下去执行;
非阻塞：就是程序可以不用等待执行的结果
​
对于阻塞与非阻塞的专有称呼有，同步阻塞，同步非阻塞，异步阻塞，异步非阻塞;而实际上我们并不需要关注同步非阻塞与异步阻塞，同步非阻塞在实现的过程中会存在一些复杂度可以采用异步非阻塞的方式巧妙地解决好;而异步阻塞其实本身意义就并不大
```
##### 长链接
```
须知:服务器建立和关闭连接均是会有资源的消耗的
长连接:其实就是一直连接的方式 
短连接:主要是建立一次连接，就没有了ajax
```
##### 心跳检测
```
在实际的生产环境中，更多的情况是在于用户通过内网的服务端 访问 上线部署的外网服务端;然而在这个过程中用户的服务端口可能因为一些网络方面的因素会造成与外网的服务器断开连接 -》 最典型的例子 “英雄联 盟突然掉线了， QQ的登入状态”; 这些在线上的过程都是属于长连接的类型，那么就会存在于这些问题;那么这个时候我们应该如何检测呢??(当然除了断开连接还有一些其他问题，比如超时，阻塞等问题 之后解释)
首先须知： 对于服务端来说信息“基本”是公开的 比如ip地址，状态基本是在运行状态; 那么客户端呢?实际上客户端并不是这么一回事，他的运行状态，ip地址不是固定的; 而对于长连接这种断开的问题;主要的点就在于服务端会保存客户端会话的有效性以及平台上监控所有客户端的网络状况;对于这种功能的实现我们可以通过两种方式实现
1. 轮询机制 
2. 心跳机制
轮询：概括来说是服务端定时主动的去与要监控状态的客户端(或者叫其他系统)通信，询问当前的某种状态，客户端返回状态信息，客户端没有返回或返回错误、失效信息、则认为客户端已经宕机，然后服务端自己 内部把这个客户端的状态保存下来(宕机或者其他)，如果客户端正常，那么返回正常状态，如果客户端宕机或者返回的是定义的失效状态那么当前的客户端状态是能够及时的监控到的，如果客户端宕机之后重启了那 么当服务端定时来轮询的时候，还是可以正常的获取返回信息，把其状态重新更新。
心跳：最终得到的结果是与轮询一样的但是实现的方式有差别，心跳不是服务端主动去发信息检测客户端状态，而是在服务端保存下来所有客户端的状态信息，然后等待客户端定时来访问服务端，更新自己的当前状态，如果客户端超过指定的时间没有来更新状态，则认为客户端已经宕机或者其状态异常。
心跳机制与轮询的比较，在我们的应用中，采用的是心跳，这样一是避免服务端的压力，二是灵活好控制，上一篇文章中提到过，我们的外网服务端(服务端)不知道内网服务端(客户端)的地址，有虽然有保存客户端的socket会话，但是客户端宕机会话就失效了。所以只能等着他主动来报告状态。
注意:在客户端向服务端发送的标识我们可以称之为叫心跳包 什么是心跳包呢?
从客户端到服务器这条巨大的链路中会经过无数的路由器，每个路由器都可能会检测多少秒时间内没有数据包，则会自动关闭连接的节能机制。为了让这个可能会出现的节能机制失效,客户端可以设置一个定时器，每隔固定时间发送一个随机字符一 字节的数据包，这种数据包就是心跳包。
```
##### Swoole 心跳检测
```
在swoole中我们可以通过set的方式来设置参数值;
heartbeat_check_interval 设置服务器定时检测在线列表的时间间隔
heartbeat_idle_time 设置连接最大的空闲时间，如果最后-一个心跳包的时间与当前时间只差超过设定值则认为连接 失效。
建议heartbeat_idle_time 比heartbeat_check_interval 的值多两倍多，两倍是为了进行容错允许丢包，多一点儿是考虑到网络延时的情况，这个可以根据实际的业务情况调整容错率。
```
##### Tcp&Udp 特点
```
Tcp：认真 可靠，1.先判断连接是不是成功的 2.再给你发送信息 3.傻傻的等待
Udp：不负责任 不靠谱，1.不需要建立连接 2.通信不需要一直保存
```
