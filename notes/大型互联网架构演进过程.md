---
attachments: [Clipboard_2022-05-10-22-11-17.png, Clipboard_2022-05-10-22-19-06.png, Clipboard_2022-05-10-22-21-45.png, Clipboard_2022-05-10-22-25-12.png, Clipboard_2022-05-10-22-28-14.png, Clipboard_2022-05-10-22-32-54.png, Clipboard_2022-05-10-22-36-27.png, Clipboard_2022-05-10-22-38-07.png, Clipboard_2022-05-10-22-39-31.png, Clipboard_2022-05-10-22-40-17.png, Clipboard_2022-05-10-22-41-12.png, Clipboard_2022-05-10-22-42-50.png, Clipboard_2022-05-15-21-16-46.png, Clipboard_2022-05-15-21-17-33.png, Clipboard_2022-05-15-21-19-19.png, Clipboard_2022-05-15-21-25-21.png, Clipboard_2022-05-15-21-25-33.png, Clipboard_2022-05-15-21-26-33.png, Clipboard_2022-05-15-21-27-11.png, Clipboard_2022-05-15-21-27-17.png, Clipboard_2022-05-15-21-28-24.png, Clipboard_2022-05-15-21-29-58.png, Clipboard_2022-05-15-21-31-12.png, Clipboard_2022-05-15-21-32-05.png, Clipboard_2022-05-15-21-32-19.png, Clipboard_2022-05-15-21-33-06.png]
favorited: true
tags: [Distributed]
title: 大型互联网架构演进过程
created: '2022-05-10T13:31:14.511Z'
modified: '2022-08-31T09:07:30.254Z'
---

# 大型互联网架构演进过程
## 1. 何为大型互联网架构
### 1.1 大型网站的特点
- 用户多，分布广泛
- 大流量，高并发
- 海量数据，服务高可用
- 安全环境恶略，易受网络攻击
- 功能多，边更快，频繁发布
- 从小到达，渐进发展
### 1.2 大型网站架构目标
- 高性能：提供快速的访问体验
- 高可用：网站服务一直可以正常访问
- 可伸缩：通过硬件增加/减少，提高/降低处理能力
- 安全性：提供网站安全访问和数据加密、安全存储等策略
- 扩展性：方便地通过新增/移除方式，增加/减少新的功能/模块
- 敏捷性：随需应变，快速响应
### 1.3 大型网站架构模式
- 分层：一般可分为应用层、服务层、数据层、管理层与分析层
- 分割：一般按照业务/模块/功能特点进行划分，比如应用层分为首页、用户中心
- 分布式：将应用分开部署（比如多台物理机），通过远程调用协同工作
- 集群：一个应用/模块/功能部署多份（如：多台物理机），通过负载均衡共同提供对外访问
- 缓存：将数据放在距离应用或用户最近的位置，加快访问速度
- 异步：将同步的操作异步化。客户端发出请求，不等待服务端响应，等服务端处理完毕后，使用通知或轮询的方式告知请求方。一般指：请求——响应——通知模式
- 冗余：增加副本，提高可用性、安全性与性能
- 安全：对已知问题有有效的解决方案，对未知/潜在问题建立发现和防御机制
- 自动化：将重复的、不需要人工参与的事情，通过工具的方式，使用机器完成
- 敏捷性：积极接受需求变更，快速响应业务发展需求

## 2. 衡量大型网站的标准与指标
技术：分布式集群、微服务架构
指标：
- QPS上千
- PV上亿
- 并发上百

<a herf="http://www.alexa.cn/traffic/bilibili.com">流量排名</a>

## 3. 分布式架构的演变过程
> 由单机计算机的架构——>分布式计算机架构

![](@attachment/Clipboard_2022-05-10-22-42-50.png)
_前言：_
> 一个成熟的大型网站系统架构并不是一开始就设计的非常完美的，世上没有完美的架构，也不是一开始就具备高性能、高可用、安全性等特性，而是随着用户量的不断增加、业务功能的扩展逐步完善演变过来的。在这个过程中，开发模式、技术架构等都会发生非常大的变化。而针对不同的业务特征的系统，会有各自的侧重点，比如像淘宝这类网站，要解决的是海量商品搜索、下单、支付等问题；像腾讯，要解决的是数亿级别用户的实时消息传输；百度所要解决的是海量数据的搜索。每一类的业务都有自己不同的系统架构。
>
> 我们以电商系统的发展演变为例，分析架构演变历程。
> 关注的是数据量、访问量提升，网站结构发生的变化，而不是具体关注业务功能点。其次，这个过程是为了让大家更好的了，解网站演进过程中的一些问题和应对策略。
>
> 假如我们系统具备以下功能：
> 用户模块：用户注册和管理
> 商品模块：商品展示和管理
> 交易模块：创建交易及支付结算

### 3.1 单机负载
<u>_最初的架构，应用程序、数据库、文件都部署在一台服务器上：资源有限、资源争抢、（数据库内存开销大，请求处理慢）_</u>
![](@attachment/Clipboard_2022-05-10-22-11-17.png)
### 3.2 单机负载越来越高，数据库服务器和应用服务器分离
> 随着网站的上线，访问量逐步上升，服务器的负载慢慢提高，在服务器还没有超载的时候，我们应该做好规划，提升网站的负载能力。假如代码层面的优化已经没办法继续提高，在不提高单台机器的性能，增加机器是一个比较好的方式，投入产出比非常高。这个阶段增加机器的主要目的是讲 web 服务器和 数据库服务器拆分，这样不仅提高了单机的负载能力，也提高了容灾能力。并且根据服务器的用途配置不同的硬件，达到最佳的性能效果。

<u>_应用、数据、文件分离：处理请求慢_</u>
![](@attachment/Clipboard_2022-05-10-22-19-06.png)
### 3.3 利用缓存改善网站性能
> 在硬件优化性能的同时，同时也通过软件进行性能优化，在大部分的网站系统中，都会利用缓存技术改善系统的性能，使用缓存主要源于热点数据的存在，大部分网站访问都遵循28原则（即80%的访问请求，最终落在20%的数据上），所以我们可以对热点数据进行缓存，减少这些数据的访问路径，提高用户体验。

<u>_利用缓存改善网站性能：应用变慢_</u>
![](@attachment/Clipboard_2022-05-10-22-21-45.png)
### 3.4 使用集群改善应用服务器性能
> 随着访问量的继续增加，单台应用服务器已经无法满足需求。在假设数据库服务器还没有遇到性能问题的时候，我们可以增加应用服务器，通过应用服务器集群将用户请求分流到各个服务器中，从而继续提升负载能力。此时多台应用服务器之间没有直接的交互，他们都是依赖数据库各自对外提供服务。应用服务器前面部署负载均衡服务器调度用户请求，根据分发策略将请求分发到多个应用服务器节点。
>
> 另外，我们还可以增加缓存服务器集群， 来提高访问速度并降低mysql等数据库的压力

<u>_应用服务器集群和缓存服务器集群：数据库负载与请求矛盾点_</u>
![](@attachment/Clipboard_2022-05-10-22-25-12.png)
### 3.5 数据库压力变大，数据库读写分离
> 架构演变到这里，并不是终点。上面我们把应用层的性能拉上来了，但是数据库的负载也在慢慢增大，那么怎么去提高数据库层面的负载呢？有了前面的思路以后，自然会想到增加服务器。但是假如我们单纯的把数据库一分为二，然后对于后续数据库的请求，分别负载到两台数据库服务器上，那么一定会造成数据库不统一的问题。 所以我们一般先考虑读写分离的方式, 。
>
> 分库分表不是这个阶段要考虑的，是数据库优化的终极技能，因为会带来一些难题，所以能不用就不用.

<u>_数据库读写分离：数据量不断增大，有很多查询请求、搜索条件复杂、like索引失效_</u>
![](@attachment/Clipboard_2022-05-10-22-28-14.png)
### 3.6 使用NoSQL和搜索引擎缓解读库的压力
> 数据库做读库的话，常常对模糊查找效率不是特别好，像电商类的网站，搜索是非常核心的功能，即便是做了读写分离，这个问题也不能有效解决。那么这个时候就需要引入Nosql和搜索引擎了。对于海量数据的查询和分析，我们使用NoSQL数据库加上搜索引擎可以达到更好的性能。并不是所有的数据都要放在关系型数据中。
>
> 常用的NoSQL有MongoDB、HBase、Redis，搜索引擎有Lucene、Solr、Elasticsearch。

<u>_NoSQL和搜索引擎：网络链路太长_</u>
![](@attachment/Clipboard_2022-05-10-22-32-54.png)
### 3.7 使用CDN和反向代理提高网站性能
> 假如我们的服务器都部署在成都的机房，对于四川的用户来说访问是较快的，而对于北京的用户访问是较慢的，这是由于四川和北京分别属于电信和联通的不同发达地区，北京用户访问需要通过互联路由器经过较长的路径才能访问到成都的服务器，返回路径也一样，所以数据传输时间比较长。对于这种情况，常常使用CDN解决，CDN将数据内容缓存到运营商的机房，用户访问时先从最近的运营商获取数据，这样大大减少了网络访问的路径。比较专业的CDN运营商有蓝汛、网宿。
>
> 而反向代理，则是部署在网站的机房，当用户请求达到时首先访问反向代理服务器，反向代理服务器将缓存的数据返回给用户，如果没有缓存数据才会继续访问应用服务器获取，这样做减少了获取数据的成本。反向代理有Squid、Nginx

<u>_使用CDN和反向代理提高网站性能：应用身兼多值、忙不过来、数据达到瓶颈_</u>
![](@attachment/Clipboard_2022-05-10-22-36-27.png)
### 3.8 将应用服务器进行业务拆分
> 随着业务进一步扩展，应用程序变得非常臃肿，这时我们需要将应用程序进行业务拆分，如百度分为新闻、网页、图片等业务。每个业务应用负责相对独立的业务运作。业务之间通过消息进行通信或者共享数据库来实现

<u>_业务拆分_</u>
![](@attachment/Clipboard_2022-05-10-22-38-07.png)
### 3.9 数据库的水平、垂直拆分
> 我们的网站演进的变化过程，交易、商品、用户的数据都在同一个数据库中，尽管采取了增加缓存，读写分离的方式，但是随着数据库的压力持续增加，数据库的瓶颈仍然是个最大的问题。因此我们可以考虑对数据的垂直拆分和水平拆分

<u>_垂直拆分：把数据库中不同业务数据拆分到不同的数据库_</u>
![](@attachment/Clipboard_2022-05-10-22-39-31.png)
<u>_水平拆分：把同一个表中的数据拆分到两个甚至跟多的数据库中，水平拆分的原因是某些业务数据量已经达到了单个数据库的瓶颈，这时可以采取讲表拆分到多个数据库中_</u>
![](@attachment/Clipboard_2022-05-10-22-40-17.png)
### 3.10 服务拆分
> 这时我们发现各个业务应用都会使用到一些基本的业务服务，例如用户服务、订单服务、支付服务、安全服务，这些服务是支撑各业务应用的基本要素。我们将这些服务抽取出来利用分部式服务框架搭建分布式服务

![](@attachment/Clipboard_2022-05-10-22-41-12.png)

## 4. 大型网站架构目标
### 1、高性能架构
以用户为中心，提供快速的网页访问体验。主要参数有较短的响应时间、较大的并发处理能力、较高的吞吐量与稳定的性能参数。可分为前端优化、应用层优化、代码层优化与存储层优化
- 前端优化：网站业务逻辑之前的部分；
- 浏览器优化：减少HTTP请求数，使用浏览器缓存，启用压缩，CSS JS位置，JS异步，减少Cookie传输；CDN加速，反向代理；
- 应用层优化：处理网站业务的服务器。使用缓存，异步，集群
- 代码优化：合理的架构，多线程，资源复用（对象池，线程池等），良好的数据结构，框架调优，单例，Cache等；
- 存储优化：缓存、固态硬盘、光纤传输、优化读写、磁盘冗余、分布式存储（HDFS）、NoSQL等。
### 2、高可用架构
大型网站应该在任何时候都可以正常访问，正常提供对外服务。因为大型网站的复杂性，分布式，廉价服务器，开源数据库，操作系统等特点，要保证高可用是很困难的，也就是说网站的故障是不可避免的。
如何提高可用性，就是需要迫切解决的问题。首先，需要从架构级别考虑，在规划的时候，就考虑可用性。行业内一般用几个9表示可用性指标，比如四个9（99.99），一年内允许的不可用时间是53分钟。
不同层级使用的策略不同，一般采用冗余备份和失效转移解决高可用问题。
- 应用层：一般设计为无状态的，对于每次请求，使用哪一台服务器处理是没有影响的。一般使用负载均衡技术（需要解决Session同步问题）实现高可用。
- 服务层：负载均衡，分级管理，快速失败（超时设置），异步调用，服务降级，幂等设计等。
- 数据层：冗余备份（冷，热备[同步，异步]，温备），失效转移（确认，转移，恢复）。数据高可用方面著名的理论基础是CAP理论（持久性，可用性，数据一致性[强一致，用户一致，最终一致]）
### 3、可伸缩架构
伸缩性是指在不改变原有架构设计的基础上，通过添加/减少硬件（服务器）的方式，提高/降低系统的处理能力。
- 应用层：对应用进行垂直或水平切分。然后针对单一功能进行负载均衡（DNS、HTTP[反向代理]、IP、链路层）。
- 服务层：与应用层类似；
- 数据层：分库、分表、NoSQL等；常用算法Hash，一致性Hash。
### 4、可扩展架构
可以方便地进行功能模块的新增/移除，提供代码/模块级别良好的可扩展性。
- 模块化，组件化：高内聚，低耦合，提高复用性，扩展性。
- 稳定接口：定义稳定的接口，在接口不变的情况下，内部结构可以“随意”变化。
- 设计模式：应用面向对象思想，原则，使用设计模式，进行代码层面的设计。
- 消息队列：模块化的系统，通过消息队列进行交互，使模块之间的依赖解耦。
- 分布式服务：公用模块服务化，提供其他系统使用，提高可重用性，扩展性。
### 5、安全架构
对已知问题有有效的解决方案，对未知/潜在问题建立发现和防御机制。对于安全问题，首先要提高安全意识，建立一个安全的有效机制，从政策层面，组织层面进行保障，比如服务器密码不能泄露，密码每月更新，并且三次内不能重复；每周安全扫描等。以制度化的方式，加强安全体系的建设。同时，需要注意与安全有关的各个环节。安全问题不容忽视，包括基础设施安全，应用系统安全，数据保密安全等。
- 基础设施安全：硬件采购，操作系统，网络环境方面的安全。一般采用正规渠道购买高质量的产品，选择安全的操作系统，及时修补漏洞，安装杀毒软件防火墙。防范病毒，后门。设置防火墙策略，建立DDOS防御系统，使用攻击检测系统，进行子网隔离等手段。
- 应用系统安全：在程序开发时，对已知常用问题，使用正确的方式，在代码层面解决掉。防止跨站脚本攻击（XSS），注入攻击，跨站请求伪造（CSRF），错误信息，HTML注释，文件上传，路径遍历等。还可以使用Web应用防火墙（比如：ModSecurity），进行安全漏洞扫描等措施，加强应用级别的安全。
- 数据保密安全：存储安全（存储在可靠的设备，实时，定时备份），保存安全（重要的信息加密保存，选择合适的人员复杂保存和检测等），传输安全（防止数据窃取和数据篡改）；
- 常用的加解密算法（单项散列加密[MD5、SHA]，对称加密[DES、3DES、RC]），非对称加密[RSA]等。
### 6、敏捷性
网站的架构设计，运维管理要适应变化，提供高伸缩性，高扩展性。方便的应对快速的业务发展，突增高流量访问等要求。除上面介绍的架构要素外，还需要引入敏捷管理，敏捷开发的思想。使业务，产品，技术，运维统一起来，随需应变，快速响应
## 5 亿级流量架构设计实战
### 5.1 大型分布式类型
分布式大型网站，目前看主要有几类：
- 大型门户，比如网易，新浪等
- SNS网站，比如校内，开心网等
- 电商网站，比如阿里巴巴，京东商城，国美在线，汽车之家等
- 直播网站，比如虎牙，斗鱼等
大型门户一般是新闻类信息，可以使用CDN，静态化等方式优化。开心网等交互性比较多，可能会引入更多的NoSQL，分布式缓存，使用高性能的通信框架等。电商网站具备以上两类的特点，比如产品详情可以采用CDN，静态化，交互性高的需要采用NoSQL等技术。
电商网站需求
- 建立一个全品类的电子商务网站（B2C）
- 希望能够支持3~5年，业务的发展
- 预计3~5年用户数达到1000万
- 定期举办双11、双12、三八男人节等活动
- 拥有成熟的进销存系统；需要与网站对接
客户需求：
- 用户可以在线购买商品，可以在线支付，也可以货到付款
- 用户购买时可以在线与客服沟通
- 用户收到商品后，可以给商品打分，评价
- 其他的功能参考京东或国美在线等网站
### 5.2 需求功能矩阵
需求管理传统的做法，会使用例图或模块图（需求列表）进行需求的描述。这样做常常忽视掉一个很重要的需求（非功能需求），因此推荐使用需求功能矩阵，进行需求描述。
本电商网站的需求矩阵如下
![](@attachment/Clipboard_2022-05-15-21-16-46.png)
### 5.3 网站初级架构
 一般网站，刚开始的做法，是三台服务器，一台部署应用，一台部署数据库，一台部署NFS文件系统。
这是前几年比较传统的做法，之前见到一个网站10万多会员，垂直服装设计门户，N多图片。使用了一台服务器部署了应用，数据库以及图片存储。出现了很多性能问题。
![](@attachment/Clipboard_2022-05-15-21-17-33.png)
NFS文件系统就是通过软件对磁盘上的数据进行组织和管理的一种机制，以达到多台机器共享访问服务器资源。
NFS包括服务端（servlet）及客户端（client）
由于NFS服务功能很多，会有很多端口，这些端口还有可能不固定，（pc -ef | egrep nfs 我们可以看到nfs 不同的端口号）那么客户端就无法与服务器进行通信，因为程序间通信必须通过端口（tcp/udp都是端到端通信），那么就需要一个中间的桥接机制，RPC进程即充当这样一个角色，RPC的端口是一定的（111），当NFS启动时，会向RPC进行注册， （rpc 一定是在nfs启动前，就已经启动了，）那么客户端PRC就能与服务器RPC进行通信， 从而进行文件的传输。
当客户端用户打开一个文件或目录时，内核会判断，该文件是本地文件还是远程共享目录文件（如果是远程共享文件就都挂载mount 到/etc/init.d/rc.local下面），如果是远程文件则通过RPC进程访问远程NFS服务端的共享目录，如果是本地文件，则直接打开。为了更好的并发，RPC进程及NFS进程都有多个。
但是，目前主流的网站架构一般都会采用集群的方式，进行高可用设计
![](@attachment/Clipboard_2022-05-15-21-19-19.png)
- 使用集群对应用服务器进行冗余，实现高可用；（负载均衡设备可与应用一块部署）
- 使用数据库主备模式，实现数据备份和高可用；
### 5.4 系统容量预估
预估步骤：
- 注册用户数-->日均UV量-->每日的PV量-->每天的并发量；
- 峰值预估：平常量的2~3倍；
- 根据并发量（并发，事务数），存储容量计算系统容量。
根据客户需求：3~5年用户数达到1000万注册用户，可以做每秒并发数预估：
- 每天的UV为200万（二八原则）；
- 每日每天点击浏览30次；
- PV量：200 * 30=6000万； 
- 集中访问量：24 * 0.2=4.8小时会有6000万 * 0.8=4800万（二八原则）；
- 每分并发量：4.8*60=288分钟，每分钟访问4800/288=16.7万（约等于）；
- 每秒并发量：16.7万/60=2780（约等于）；
- 假设：高峰期为平常值的三倍，则每秒的并发数可以达到8340次。
- 1毫秒=1.3次访问；
服务器预估：（以PHP举例）
按一台web服务器，支持每秒300个并发计算。平常需要10台服务器（约等于）；[PHP默认配置是150]，高峰期需要30台服务器；
容量预估：70/90原则
系统CPU一般维持在70%左右的水平，高峰期达到90%的水平，是不浪费资源，并比较稳定的。内存，IO类似。
以上预估仅供参考，因为服务器配置，业务逻辑复杂度等都有影响。在此CPU，硬盘，网络等不再进行评估。
### 5.5 网站架构分析
根据以上预估，有几个问题：
- 需要部署大量的服务器，高峰期计算，可能要部署30台Web服务器。并且这三十台服务器，只有秒杀，活动时才会用到，存在大量的浪费。
- 所有的应用部署在同一台服务器，应用之间耦合严重。需要进行垂直切分和水平切分。
- 大量应用存在冗余代码
- 服务器Session同步耗费大量内存和网络带宽
- 数据需要频繁访问数据库，数据库访问压力巨大。
大型网站一般需要做以下架构优化（优化是架构设计时，就要考虑的，一般从架构/代码级别解决，调优主要是简单参数的调整；如果调优涉及大量代码改造，就不是调优了，属于重构）：
- 业务拆分
- 应用集群部署（分布式部署，集群部署和负载均衡）
- 多级缓存
- 单点登录（分布式Session）
- 数据库集群（读写分离，分库分表）
- 服务化
- 消息队列
- 其他技术
### 5.6 网站架构优化
#### 5.6.1 业务拆分
- 根据业务属性进行垂直切分，划分为产品子系统，购物子系统，支付子系统，评论子系统，客服子系统，接口子系统（对接如进销存，短信等外部系统）。
- 根据业务子系统进行等级定义，可分为核心系统和非核心系统。核心系统：产品子系统，购物子系统，支付子系统；非核心：评论子系统，客服子系统，接口子系统。
  * 业务拆分作用：提升为子系统可由专门的团队和部门负责，专业的人做专业的事，解决模块之间耦合以及扩展性问题；每个子系统单独部署，避免集中部署导致一个应用挂了，全部应用不可用的问题。
  * 等级定义作用：用于流量突发时，对关键应用进行保护，实现优雅降级；保护关键应用不受到影响。
拆分后的架构图：
![](@attachment/Clipboard_2022-05-15-21-25-21.png)
参考部署方案2
![](@attachment/Clipboard_2022-05-15-21-25-33.png)
如上图每个应用单独部署，核心系统和非核心系统组合部署
#### 5.6.2应用集群部署（分布式，集群，负载均衡)
- 分布式部署：将业务拆分后的应用单独部署，应用直接通过RPC进行远程通信；
- 集群部署：电商网站的高可用要求，每个应用至少部署两台服务器进行集群部署；
- 负载均衡：是高可用系统必须的，一般应用通过负载均衡实现高可用，分布式服务通过内置的负载均衡实现高可用，关系型数据库通过主备方式实现高可用。
集群部署后架构图：
![](@attachment/Clipboard_2022-05-15-21-26-33.png)
#### 5.6.3 多级缓存
缓存按照存放的位置一般可分为两类本地缓存和分布式缓存。本案例采用二级缓存的方式，进行缓存的设计。一级缓存为本地缓存，二级缓存为分布式缓存。（还有页面缓存，片段缓存等，那是更细粒度的划分）
一级缓存，缓存数据字典，和常用热点数据等基本不可变/有规则变化的信息，二级缓存缓存需要的所有缓存。当一级缓存过期或不可用时，访问二级缓存的数据。如果二级缓存也没有，则访问数据库。
缓存的比例，一般1:4，即可考虑使用缓存。（理论上是1:2即可）。
![](@attachment/Clipboard_2022-05-15-21-27-11.png)
根据业务特性可使用以下缓存过期策略：
- 缓存自动过期；
- 缓存触发过期；
#### 5.6.4单点登录（分布式Session)
系统分割为多个子系统，独立部署后，不可避免的会遇到会话管理的问题。一般可采用Session同步，Cookies，分布式Session方式。电商网站一般采用分布式Session实现。
再进一步可以根据分布式Session，建立完善的单点登录或账户管理系统。
![](@attachment/Clipboard_2022-05-15-21-28-24.png)
流程说明
- 用户第一次登录时，将会话信息（用户Id和用户信息），比如以用户Id为Key，写入分布式Session；
- 用户再次登录时，获取分布式Session，是否有会话信息，如果没有则调到登录页；
- 一般采用Cache中间件实现，建议使用Redis，因此它有持久化功能，方便分布式Session宕机后，可以从持久化存储中加载会话信息；
- 存入会话时，可以设置会话保持的时间，比如15分钟，超过后自动超时；
结合Cache中间件，实现的分布式Session，可以很好的模拟Session会话。
#### 5.6.5数据库集群（读写分离，分库分表）
大型网站需要存储海量的数据，为达到海量数据存储，高可用，高性能一般采用冗余的方式进行系统设计。一般有两种方式读写分离和分库分表。
读写分离：一般解决读比例远大于写比例的场景，可采用一主一备，一主多备或多主多备方式。
本案例在业务拆分的基础上，结合分库分表和读写分离。如下图：
![](@attachment/Clipboard_2022-05-15-21-29-58.png)
- 业务拆分后：每个子系统需要单独的库；
- 如果单独的库太大，可以根据业务特性，进行再次分库，比如商品分类库，产品库；
- 分库后，如果表中有数据量很大的，则进行分表，一般可以按照Id，时间等进行分表；（高级的用法是一致性Hash）
- 在分库、分表的基础上，进行读写分离；
相关中间件可参考Cobar（阿里，目前已不在维护），TDDL（阿里），Atlas（奇虎360），MyCat。
分库分表后序列的问题，JOIN，事务的问题，会在分库分表主题介绍。
#### 5.6.6服务化
将多个子系统公用的功能/模块，进行抽取，作为公用服务使用。比如本案例的会员子系统就可以抽取为公用的服务。
![](@attachment/Clipboard_2022-05-15-21-31-12.png)
#### 5.6.7消息队列
消息队列可以解决子系统/模块之间的耦合，实现异步，高可用，高性能的系统。是分布式系统的标准配置。本案例中，消息队列主要应用在购物，配送环节。
- 用户下单后，写入消息队列，后直接返回客户端；
- 库存子系统：读取消息队列信息，完成减库存；
- 配送子系统：读取消息队列信息，进行配送；
![](@attachment/Clipboard_2022-05-15-21-32-19.png)
目前使用较多的MQ有ActiveMQ、RabbitMQ、ZeroMQ、MSMQ等，需要根据具体的业务场景进行选择。建议可以研究下RabbitMQ。
#### 5.6.8其他架构（技术）
除了以上介绍的业务拆分，应用集群，多级缓存，单点登录，数据库集群，服务化，消息队列外。还有CDN，反向代理，分布式文件系统，大数据处理等系统。
### 5.7、架构汇总
![](@attachment/Clipboard_2022-05-15-21-33-06.png)

